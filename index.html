<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>دليل مواقع جامعة القصيم</title>
    <meta name="description" content="وصول سريع ومنظم لجميع مواقع الكليات والعمادات والمرافق بجامعة القصيم.">
    <meta name="theme-color" content="#F7F9FC">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
      :root {
        --accent-color: #316FEA;
        --dark-blue: #0A2D57;
        --bg-main: #F7F9FC;
        --bg-card: #FFFFFF;
        --bg-button: #F0F4F8;
        --text-dark: #192a4e;
        --text-secondary: #8A94A6;
        --radius-card: 24px;
        --radius-button: 16px;
        --radius-full: 999px;
        --shadow: 0 10px 40px -15px rgba(150, 170, 200, 0.4);
        --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1);
      }

      * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      html { scroll-behavior: smooth; }

      @keyframes popIn { 
        from { opacity: 0; transform: translateY(20px) scale(0.98); } 
        to { opacity: 1; transform: translateY(0) scale(1); } 
      }
      @keyframes fadeOut { to { opacity: 0; transform: translateY(10px); } }

      body {
        font-family: 'IBM Plex Sans Arabic', sans-serif;
        background-color: var(--bg-main);
        color: var(--text-dark);
        direction: rtl;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
      }

      .app-wrapper {
        max-width: 800px;
        margin: 0 auto;
        padding: 1.5rem 1.5rem 6rem;
      }
      
      .page-header {
        background-image: linear-gradient(160deg, #12427d, var(--dark-blue)),
                          radial-gradient(circle at 0% 0%, rgba(255, 255, 255, 0.1) 0%, transparent 40%);
        color: #FFFFFF;
        padding: 2.5rem;
        border-radius: var(--radius-card);
        text-align: center;
        box-shadow: 0 10px 30px -10px rgba(10, 45, 87, 0.5);
        animation: popIn 0.8s var(--ease-out-quint) .1s both;
      }
      .page-title {
        font-size: clamp(2.2rem, 8vw, 2.8rem);
        font-weight: 700;
        line-height: 1.3;
      }
      .page-subtitle {
        font-size: 1rem;
        max-width: 450px;
        margin: 0.5rem auto 0;
        line-height: 1.7;
        font-weight: 400;
        opacity: 0.8;
      }
      
      .controls-container {
        position: relative;
        margin-top: -2.5rem;
        margin-bottom: 2rem;
        z-index: 10;
        animation: popIn 0.8s var(--ease-out-quint) .2s both;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2rem;
      }

      .search-container {
        position: relative;
        width: 100%;
        max-width: 550px;
      }
      .search-icon {
        position: absolute;
        top: 50%;
        right: 28px;
        transform: translateY(-50%);
        color: var(--text-secondary);
        transition: color 0.3s ease;
        pointer-events: none;
      }
      #search-input {
        width: 100%;
        padding: 1.1rem 3.5rem 1.1rem 1.5rem;
        background: var(--bg-card);
        border: 2px solid var(--bg-card);
        border-radius: var(--radius-full);
        color: var(--text-dark);
        font-family: 'IBM Plex Sans Arabic', sans-serif;
        font-size: 1rem;
        font-weight: 600;
        box-shadow: 0 15px 35px -10px rgba(150, 170, 200, 0.3);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }
      #search-input::placeholder { color: var(--text-secondary); }
      #search-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 10px 30px -10px rgba(49, 111, 234, 0.4);
      }
      #search-input:focus ~ .search-icon { color: var(--accent-color); }
      
      .filter-container {
        display: flex;
        justify-content: center;
        gap: 2.5rem;
        width: 100%;
      }
      .filter-btn {
        background: transparent; border: none; font-family: 'IBM Plex Sans Arabic', sans-serif; font-weight: 700;
        font-size: 1.1rem; color: var(--text-secondary); cursor: pointer; padding: 0.5rem 0.25rem;
        transition: color 0.3s ease; position: relative;
      }
      .filter-btn.is-active { color: var(--accent-color); }
      .filter-btn::after {
        content: ''; position: absolute; bottom: 0; right: 0;
        width: 100%; height: 3px; background-color: var(--accent-color); border-radius: 2px;
        transform: scaleX(0); transition: transform 0.3s var(--ease-out-quint);
      }
      .filter-btn.is-active::after { transform: scaleX(1); }

      .content-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.25rem;
        min-height: 200px;
      }
      
      .content-card {
        background-color: var(--bg-card);
        border-radius: var(--radius-card);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        animation: popIn 0.6s var(--ease-out-quint) both;
        animation-delay: var(--animation-order, 0s);
      }
      .is-filtered-out { display: none !important; }
      .is-hiding { animation: fadeOut 0.3s ease-out forwards; animation-delay: var(--animation-order, 0s); }
      .is-showing { animation: popIn 0.6s var(--ease-out-quint) both; animation-delay: var(--animation-order, 0s); }
      
      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--bg-main);
      }
      .card-title-group {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-direction: row-reverse;
      }
      .card-header .title { font-size: 1.6rem; font-weight: 700; color: var(--text-dark); }
      .card-header .icon-wrapper {
        width: 44px; height: 44px;
        border-radius: 12px;
        background-color: var(--bg-button);
        color: var(--accent-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }

      .links-group { display: flex; flex-direction: column; gap: 0.75rem; }
      .location-link {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        border-radius: var(--radius-button);
        background: var(--bg-button);
        text-decoration: none;
        font-weight: 600;
        font-size: 1rem;
        transition: background-color 0.2s ease, color 0.2s ease;
        color: var(--text-dark);
      }
      .location-link:hover {
        background-color: #e4eaf3;
      }
      .link-main-content {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .location-link i { font-size: 1.1rem; color: var(--accent-color); }
      
      .building-badge {
        min-width: 32px; height: 32px;
        padding: 0 0.5rem;
        border-radius: 8px;
        background: var(--accent-color); color: white;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.9rem; font-weight: 700; flex-shrink: 0;
        box-shadow: 0 2px 5px rgba(49, 111, 234, 0.3);
      }
      
      .link-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .map-btn-small {
        width: 32px; height: 32px;
        border-radius: 8px;
        background: var(--bg-main);
        color: var(--accent-color);
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        font-size: 1rem;
        flex-shrink: 0;
        transition: background-color 0.2s ease, transform 0.2s ease;
        cursor: pointer;
      }
      .map-btn-small:hover {
        background-color: #e4eaf3;
        transform: scale(1.1);
      }
      
      .empty-state { display: none; grid-column: 1 / -1; justify-content: center; align-items: center; text-align: center; padding: 4rem 1.5rem; flex-direction: column; gap: 1.5rem; color: var(--text-dark); }
      .empty-state.is-visible { display: flex; }
      .empty-state .icon { font-size: 3rem; color: var(--accent-color); opacity: 0.5; }
      .empty-state span { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; }
      .empty-state .reset-btn { background: var(--accent-color); color: white; border: none; padding: 0.8rem 2rem; border-radius: var(--radius-full); font-family: 'IBM Plex Sans Arabic', sans-serif; font-size: 1rem; font-weight: 700; cursor: pointer; transition: transform 0.2s ease; }
      .empty-state .reset-btn:hover { transform: scale(1.05); }

      .page-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--dark-blue);
        color: white;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1.5rem;
        z-index: 20;
      }
      .footer-link {
        color: white;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        opacity: 0.8;
        transition: opacity 0.2s ease;
        flex-direction: row-reverse;
      }
      .footer-link:hover {
        opacity: 1;
      }
      .footer-link .icon-bg {
        width: 28px; height: 28px;
        border-radius: 50%;
        background-color: var(--accent-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
      }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <header class="page-header">
            <h1 class="page-title">دليل مواقع الجامعة</h1>
            <p class="page-subtitle">وصول سريع ومنظم لجميع مواقع الكليات والعمادات والمرافق داخل الحرم الجامعي.</p>
        </header>
        
        <div class="controls-container">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="search" id="search-input" placeholder="ابحث عن كلية, عمادة, مرفق..." aria-label="صندوق البحث">
            </div>

            <div class="filter-container" id="filter-container">
                <!-- Filter buttons will be injected here -->
            </div>
        </div>

        <main class="content-grid" id="content-grid">
            <div class="empty-state" id="empty-state">
                <i class="fas fa-map-marked-alt icon"></i>
                <span>لا توجد نتائج تطابق بحثك.</span>
                <button class="reset-btn" id="reset-filter-btn">عرض الكل</button>
            </div>
        </main>
    </div>
    
    <footer class="page-footer">
        <a href="https://t.me/Qassim_U" class="footer-link" target="_blank" rel="noopener noreferrer">
            <span class="icon-bg"><i class="fas fa-users"></i></span>
            <span>Qassim_U</span>
        </a>
        <a href="#" class="footer-link" target="_blank" rel="noopener noreferrer">
            <span class="icon-bg"><i class="fas fa-bullhorn"></i></span>
            <span>Qassim_QU</span>
        </a>
    </footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SITE_DATA_RAW = [
                { category: 'colleges', title: 'الكليات', icon: 'fa-university', type: 'multi-department', departments: [
                    { title: "كلية الحاسب", icon: "fa-laptop-code", links: [ 
                        { href: "#", text: "طلاب", icon: "fa-map-pin", building: "C1" }, 
                        { href: "https://maps.app.goo.gl/nfvJK3LXANxUvGMR7", text: "طالبات", icon: "fa-map-pin", building: "F5", map_pdf: "maps/map-college-of-computer-f5.pdf" }, 
                        { href: "https://maps.app.goo.gl/FpWckdfczc1Zw9SGA", text: "مقر الرس - طلاب", icon: "fa-map-pin" }, 
                        { href: "https://maps.app.goo.gl/ziGGqiiRmVWgAsK77", text: "مقر الرس - طالبات", icon: "fa-map-pin" }, 
                        { href: "https://maps.app.goo.gl/TJKpwvu5PU3hiUUE9", text: "مقر عنيزة - طلاب", icon: "fa-map-pin" }, 
                        { href: "https://goo.gl/maps/5cXcGmWgRgxCFugY8", text: "مقر عنيزة - طالبات", icon: "fa-map-pin" } 
                    ] },
                    { title: "كلية العمارة والتخطيط", icon: "fa-drafting-compass", links: [ { href: "https://maps.app.goo.gl/azhphjNfXgcVrnRE7", text: "طلاب", icon: "fa-map-pin", building: "C1" }, { href: "https://maps.app.goo.gl/UA4LTM4DAhYRCBXU9", text: "طالبات", icon: "fa-map-pin", building: "F8" } ] },
                    { title: "كلية الهندسة", icon: "fa-cogs", links: [ 
                        { href: "https://maps.app.goo.gl/6cJJjN3jw5Z4aNqn8", text: "طلاب", icon: "fa-map-pin", building: "A5" }, 
                        { href: "https://maps.app.goo.gl/QWpAQijbvtfAGJ9x7", text: "طالبات", icon: "fa-map-pin", map_pdf: "maps/map-college-of-engineering-b1.pdf" } 
                    ] },
                    { title: "كلية العلوم", icon: "fa-flask", links: [ 
                        { href: "https://maps.app.goo.gl/NNbJHtvKZjziWgtf9", text: "طلاب", icon: "fa-map-pin", building: "A4" }, 
                        { href: "https://maps.app.goo.gl/qYiczcvZ594ifjao8", text: "طالبات", icon: "fa-map-pin", building: "F2", map_pdf: "maps/map-college-of-sciences-f2.pdf" }, 
                        { href: "https://maps.app.goo.gl/uJY8YNhn598UDJFw9", text: "مقر الرس - طلاب", icon: "fa-map-pin" }, 
                        { href: "https://maps.app.goo.gl/STNWoVgsdKQ78nLB9", text: "مقر الرس - طالبات", icon: "fa-map-pin" }, 
                        { href: "https://maps.app.goo.gl/SLNMizwQA8JKE1o76", text: "مقر عنيزة - طلاب", icon: "fa-map-pin" }, 
                        { href: "https://maps.app.goo.gl/RErZQdojf7fAFMCc9", text: "مقر عنيزة - طالبات", icon: "fa-map-pin" } 
                    ] },
                    { title: "كلية الشريعة", icon: "fa-balance-scale", links: [ 
                        { href: "https://maps.app.goo.gl/JdafjR42wc5We6Dk6", text: "طلاب", icon: "fa-map-pin", building: "A6" }, 
                        { href: "https://maps.app.goo.gl/9PEBr5XunvbzFNGY7", text: "طالبات", icon: "fa-map-pin", building: "F6" } 
                    ] },
                    { title: "كلية اللغات", icon: "fa-language", links: [ { href: "https://maps.app.goo.gl/6nU1yHd6AZMMqniq8", text: "طلاب", icon: "fa-map-pin", building: "A6" }, { href: "https://maps.app.goo.gl/5rBrvtixLZC58Lcv8", text: "مقر بريدة - طالبات", icon: "fa-map-pin" } ] },
                    { title: "كلية الزراعة", icon: "fa-seedling", links: [ { href: "https://maps.app.goo.gl/vRR1WiavypoHSCnR6", text: "طلاب", icon: "fa-map-pin", building: "A2" }, { href: "https://maps.app.goo.gl/ZNJbwtedqVhkoMSY7", text: "طالبات", icon: "fa-map-pin", building: "F7" } ] },
                    { title: "كلية الطب البيطري", icon: "fa-paw", links: [ { href: "https://maps.app.goo.gl/e5Dh4j2iz4j6UAHG7", text: "طلاب", icon: "fa-map-pin", building: "A2" } ] },
                    { title: "كلية الإدارة والاقتصاد", icon: "fa-chart-line", links: [ { href: "https://maps.app.goo.gl/u4pxY6yhebFBZ5oX6", text: "طلاب", icon: "fa-map-pin", building: "A3" }, { href: "https://maps.app.goo.gl/xcy39GeUZnNK69SbA", text: "طالبات", icon: "fa-map-pin", building: "F3" }, { href: "https://maps.app.goo.gl/uJY8YNhn598UDJFw9", text: "مقر الرس - طلاب", icon: "fa-map-pin" }, { href: "https://maps.app.goo.gl/x8142f18EaHyCqAv8", text: "مقر الرس - طالبات", icon: "fa-map-pin" } ] },
                    { title: "كلية التربية", icon: "fa-chalkboard-teacher", links: [ { href: "https://maps.app.goo.gl/E3nZVpYi7t6j3FY49", text: "طلاب", icon: "fa-map-pin", building: "A14" }, { href: "https://maps.app.goo.gl/UA4LTM4DAhYRCBXU9", text: "طالبات", icon: "fa-map-pin", building: "F8" }, { href: "https://maps.app.goo.gl/Vv6xvC99yEU6BZBAA", text: "مقر رياض الخبراء - طالبات", icon: "fa-map-pin" } ] },
                    { title: "كلية الطب", icon: "fa-user-md", links: [ { href: "#", text: "طلاب", icon: "fa-map-pin", building: "B2" } ] },
                    { title: "كلية الصيدلة", icon: "fa-pills", links: [ { href: "#", text: "طلاب", icon: "fa-map-pin", building: "B4" } ] },
                    { title: "كلية التمريض", icon: "fa-briefcase-medical", links: [ { href: "#", text: "طلاب", icon: "fa-map-pin", building: "B5" } ] },
                    { title: "كلية العلوم الطبية التطبيقية", icon: "fa-stethoscope", links: [ { href: "#", text: "طلاب", icon: "fa-map-pin", building: "A4" } ] },
                    { title: "الكلية التطبيقية", icon: "fa-layer-group", links: [ { href: "#", text: "طلاب", icon: "fa-map-pin", building: "C2" }, { href: "https://www.qu.edu.sa/colleges/qac/locations/", text: "بقية الفروع", icon: "fa-external-link-alt" } ] },
                    { title: "كلية الفنون والتصاميم", icon: "fa-palette", links: [ { href: "https://maps.app.goo.gl/rwWGc4zkcCwSmeog6", text: "طالبات", icon: "fa-map-pin", building: "F7" } ] }
                ]},
                { category: 'deanships', title: 'العمادات', icon: 'fa-building-user', links: [ { href: "https://maps.app.goo.gl/SGGQX3GqQjDU9Cc6A", icon: "fa-id-card-alt", text: "عمادة القبول والتسجيل" }, { href: "https://maps.app.goo.gl/uavC8yXQFrNfrnR16", icon: "fa-users-cog", text: "عمادة شؤون الطلاب" }, { href: "https://maps.app.goo.gl/uL7L58xZxehJ4pqt7", icon: "fa-book-reader", text: "عمادة الدراسات العليا والبحث العلمي" }, { href: "https://maps.app.goo.gl/4zfgdfTRLjNhVCAD9", icon: "fa-desktop", text: "عمادة التعلم الإلكتروني وتقنية المعلومات" } ] },
                { category: 'facilities', title: 'المرافق والخدمات', icon: 'fa-map-signs', links: [ { href: "https://www.google.com/maps/place//data=!4m2!3m1!1s0x158201c7a8c21d91:0xedc23a33b8b771a4", icon: "fa-hospital-user", text: "المدينة الطبية" }, { href: "https://www.google.com/maps/place//data=!4m2!3m1!1s0x158201c8cbe278f7:0xb16f62d6ae48782", icon: "fa-clinic-medical", text: "العيادات الخارجية" }, { href: "https://maps.app.goo.gl/kP97DjbXH2CpSUUE8", icon: "fa-car", text: "مدرسة تعليم القيادة" }, { href: "https://maps.app.goo.gl/Fswf7gNWLw4ikM2B9", icon: "fa-shield-alt", text: "الأمن الجامعي" }, { href: "https://goo.gl/maps/hUDYwKSKuPqRuBz36", icon: "fa-dumbbell", text: "النادي الرياضي" }, { href: "https://maps.app.goo.gl/2CEU2VFW5bPPCZUV8", icon: "fa-futbol", text: "ملعب الجامعة" }, { href: "https://maps.app.goo.gl/YnZUmvuQzq5s6wsV8", icon: "fa-microphone-alt", text: "مركز المؤتمرات" }, { href: "https://maps.app.goo.gl/SbvFZ5XCKpAtdLsS9", icon: "fa-lightbulb", text: "مركز ريادة الأعمال الرقمية | كود" }, { href: "https://maps.app.goo.gl/sdy9NRSA6iT8WXn68", icon: "fa-building", text: "إدارة السكن" }, { href: "https://maps.app.goo.gl/rCG7yk96fjyPBS4T8", icon: "fa-bed", text: "السكن الطلابي (بنين)" } ] }
            ];
            
            const FLATTENED_DATA = [];
            SITE_DATA_RAW.forEach(category => {
                if (category.type === 'multi-department') {
                    category.departments.forEach(dept => FLATTENED_DATA.push({ ...dept, category: category.category }));
                } else { FLATTENED_DATA.push(category); }
            });

            const PRIMARY_FILTERS = [ { id: 'deanships', text: 'العمادات' }, { id: 'colleges', text: 'الكليات' }, { id: 'facilities', text: 'المرافق' } ];
            const DEFAULT_FILTER = 'colleges';
            
            const grid = document.getElementById('content-grid'), 
                  emptyState = document.getElementById('empty-state'),
                  searchInput = document.getElementById('search-input'),
                  filterContainer = document.getElementById('filter-container');
            let activePrimaryFilterId = DEFAULT_FILTER, isAnimating = false;

            const createCardHTML = (cardData, index) => {
                const header = `
                    <div class="card-header">
                        <div class="card-title-group">
                            <h2 class="title">${cardData.title}</h2>
                            <div class="icon-wrapper"><i class="fas ${cardData.icon}"></i></div>
                        </div>
                    </div>`;
                
                const createLinksGroup = links => `<div class="links-group">${links.map(link => {
                    const badgeHTML = link.building ? `<div class="building-badge">${link.building}</div>` : '';
                    
                    const mapButtonHTML = link.map_pdf
                        ? `<div role="button" onclick="event.preventDefault(); event.stopPropagation(); window.open('${link.map_pdf}', '_blank');" class="map-btn-small" title="مخطط المبنى"><i class="fas fa-map-marked-alt"></i></div>`
                        : '';
                    
                    return `<a href="${link.href}" target="_blank" rel="noopener noreferrer" class="location-link">
                                <div class="link-main-content">
                                    <i class="fas ${link.icon}"></i>
                                    <span>${link.text}</span>
                                </div>
                                <div class="link-actions">
                                    ${mapButtonHTML}
                                    ${badgeHTML}
                                </div>
                            </a>`;
                }).join('')}</div>`;

                const body = createLinksGroup(cardData.links);
                return `<section class="content-card is-filtered-out" data-category="${cardData.category}" style="--animation-order: ${index * 50}ms">${header}${body}</section>`;
            };
            
            const filterContent = () => {
                if (isAnimating) return; 
                isAnimating = true;

                const searchQuery = searchInput.value.toLowerCase().trim();
                const cards = Array.from(grid.querySelectorAll('.content-card'));
                const toHide = [], toShow = [];
                let visibleCardCount = 0;
                
                cards.forEach(card => {
                    const categoryMatch = card.dataset.category === activePrimaryFilterId;
                    const searchMatch = searchQuery === '' || card.textContent.toLowerCase().includes(searchQuery);
                    const shouldShow = categoryMatch && searchMatch;

                    if (shouldShow) visibleCardCount++;
                    const isVisible = !card.classList.contains('is-filtered-out');

                    if (shouldShow && !isVisible) toShow.push(card);
                    else if (!shouldShow && isVisible) toHide.push(card);
                });

                emptyState.classList.toggle('is-visible', visibleCardCount === 0);
                let hideAnimationTime = toHide.length * 40 + 200;
                toHide.forEach((card, i) => { card.style.setProperty('--animation-order', `${i * 30}ms`); card.classList.add('is-hiding'); card.addEventListener('animationend', () => { card.classList.add('is-filtered-out'); card.classList.remove('is-hiding'); }, { once: true }); });
                
                setTimeout(() => {
                    toShow.forEach((card, i) => { card.style.setProperty('--animation-order', `${i * 50}ms`); card.classList.remove('is-filtered-out'); card.classList.add('is-showing'); card.addEventListener('animationend', () => card.classList.remove('is-showing'), { once: true }); });
                    setTimeout(() => { isAnimating = false; }, toShow.length * 50 + 300);
                }, toHide.length > 0 ? hideAnimationTime : 0);
            };
            
            const initFilters = () => {
                filterContainer.innerHTML = PRIMARY_FILTERS.map(f => 
                    `<button class="filter-btn" data-filter="${f.id}">${f.text}</button>`
                ).join('');

                const filterButtons = filterContainer.querySelectorAll('.filter-btn');

                const handleFilterClick = (e) => {
                    const targetButton = e.currentTarget;
                    const newFilterId = targetButton.dataset.filter;
                    
                    if (activePrimaryFilterId === newFilterId) return;
                    activePrimaryFilterId = newFilterId;

                    filterButtons.forEach(btn => btn.classList.remove('is-active'));
                    targetButton.classList.add('is-active');

                    filterContent();
                };

                filterButtons.forEach(btn => btn.addEventListener('click', handleFilterClick));
                
                return {
                    setActive: (filterId) => {
                        activePrimaryFilterId = filterId;
                        filterButtons.forEach(btn => {
                            btn.classList.toggle('is-active', btn.dataset.filter === filterId);
                        });
                        filterContent();
                    },
                    activateDefault: () => {
                      const defaultButton = filterContainer.querySelector(`[data-filter="${DEFAULT_FILTER}"]`);
                      if(defaultButton) defaultButton.classList.add('is-active');
                    }
                };
            };
            
            const initialize = () => {
                const cardHTML = FLATTENED_DATA.map(createCardHTML).join('');
                grid.insertAdjacentHTML('afterbegin', cardHTML);
                
                const filterManager = initFilters();
                
                document.getElementById('reset-filter-btn').addEventListener('click', () => {
                    searchInput.value = '';
                    filterManager.setActive(DEFAULT_FILTER);
                });

                searchInput.addEventListener('input', filterContent);
                
                filterManager.activateDefault();
                filterContent(); 
            };

            initialize();
        });
    </script>
</body>
</html>
